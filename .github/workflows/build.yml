on:
  pull_request:
    branches:
      - main

name: Build renameat2

jobs:
  manylinux:
    runs-on: ubuntu-20.04

    strategy:
      fail-fast: false
      matrix:
        python:
          - cp36-cp36m
          - cp37-cp37m
          - cp38-cp38
          - cp39-cp39
        arch:
          - x86_64
          - i686
          - aarch64

    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1

      - uses: actions/checkout@v2

      - name: Build manylinux wheel
        run: |
          set -euo pipefail

          if [ "$ARCH" = "aarch64" ]; then
            export BASEPLAT=manylinux2014
          fi

          docker-compose -f builder/docker-compose.yml build --pull
          docker-compose -f builder/docker-compose.yml run manylinux build-wheel.sh
        env:
          WHICH_PYTHON: ${{ matrix.python }}
          ARCH: ${{ matrix.arch }}

  sdist:
    runs-on: ubuntu-20.04

    steps:
      - uses: actions/checkout@v2

      - name: Build sdist
        run: |
          set -euo pipefail

          docker-compose -f builder/docker-compose.yml build --pull
          docker-compose -f builder/docker-compose.yml run manylinux /opt/python/cp36-cp36m/bin/python3 setup.py sdist
